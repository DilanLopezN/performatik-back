generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model File {
  id           String   @id @default(uuid())
  filename     String
  originalName String   @map("original_name")
  mimeType     String   @map("mime_type")
  size         Int
  key          String   @unique
  url          String
  uploadedBy   String?  @map("uploaded_by")
  metadata     Json?
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@map("files")
}

model User {
  id                 String              @id @default(uuid())
  email              String              @unique
  passwordHash       String
  name               String
  timezone           String              @default("America/Sao_Paulo")
  weightKg           Decimal?            @db.Decimal(5, 2)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  bodyCheckins       BodyCheckin[]
  bodyProfile        BodyProfile?
  ownedGroups        Group[]             @relation("GroupOwner")
  groupMemberships   GroupMember[]
  groupPosts         GroupPost[]         @relation("GroupPostAuthor")
  groupPostComments  GroupPostComment[]
  groupPostReactions GroupPostReaction[]
  habits             Habit[]
  hydrationLogs      HydrationLog[]
  hydrationProfile   HydrationProfile?
  mediaAssets        MediaAsset[]
  motivationalNotes  MotivationalNote[]
  notificationRules  NotificationRule[]

  @@index([createdAt])
  @@map("users")
}

model Habit {
  id          String              @id @default(uuid())
  ownerUserId String
  type        HabitType
  title       String
  isActive    Boolean             @default(true)
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  owner       User                @relation(fields: [ownerUserId], references: [id])
  checkins    HabitDailyCheckin[]
  relapses    HabitRelapse[]

  @@index([ownerUserId, type])
}

model HabitRelapse {
  id        String   @id @default(uuid())
  habitId   String
  relapseAt DateTime
  note      String?
  createdAt DateTime @default(now())
  habit     Habit    @relation(fields: [habitId], references: [id])

  @@index([habitId, relapseAt])
}

model HabitDailyCheckin {
  id          String             @id @default(uuid())
  habitId     String
  checkinDate DateTime           @db.Date
  status      HabitCheckinStatus
  note        String?
  createdAt   DateTime           @default(now())
  habit       Habit              @relation(fields: [habitId], references: [id])

  @@unique([habitId, checkinDate])
  @@index([habitId, checkinDate])
}

model HydrationProfile {
  id          String   @id @default(uuid())
  userId      String   @unique
  dailyGoalMl Int
  goalFormula String?
  updatedAt   DateTime @updatedAt
  user        User     @relation(fields: [userId], references: [id])
}

model HydrationLog {
  id        String   @id @default(uuid())
  userId    String
  logDate   DateTime @db.Date
  amountMl  Int
  loggedAt  DateTime
  source    String?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])

  @@index([userId, logDate])
  @@index([userId, loggedAt])
}

model NotificationRule {
  id              String   @id @default(uuid())
  userId          String
  type            String
  isEnabled       Boolean  @default(true)
  startTime       DateTime @db.Time(6)
  endTime         DateTime @db.Time(6)
  intervalMinutes Int
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  user            User     @relation(fields: [userId], references: [id])

  @@index([userId, type])
}

model BodyProfile {
  id        String   @id @default(uuid())
  userId    String   @unique
  heightCm  Int?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id])
}

model BodyCheckin {
  id            String             @id @default(uuid())
  userId        String
  weekStartDate DateTime           @db.Date
  notes         String?
  createdAt     DateTime           @default(now())
  user          User               @relation(fields: [userId], references: [id])
  photos        BodyCheckinPhoto[]
  measurements  BodyMeasurement?

  @@unique([userId, weekStartDate])
  @@index([userId, weekStartDate])
}

model BodyMeasurement {
  id            String      @id @default(uuid())
  bodyCheckinId String      @unique
  weightKg      Decimal?    @db.Decimal(5, 2)
  waistCm       Decimal?    @db.Decimal(5, 2)
  chestCm       Decimal?    @db.Decimal(5, 2)
  hipCm         Decimal?    @db.Decimal(5, 2)
  armCm         Decimal?    @db.Decimal(5, 2)
  thighCm       Decimal?    @db.Decimal(5, 2)
  bodyCheckin   BodyCheckin @relation(fields: [bodyCheckinId], references: [id])
}

model MotivationalNote {
  id        String   @id @default(uuid())
  userId    String
  title     String?
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id])

  @@index([userId, createdAt])
}

model MediaAsset {
  id                String             @id @default(uuid())
  ownerUserId       String
  storageProvider   String
  bucket            String
  objectKey         String
  contentType       String
  sizeBytes         BigInt
  width             Int?
  height            Int?
  createdAt         DateTime           @default(now())
  bodyCheckinPhotos BodyCheckinPhoto[]
  groupPostMedias   GroupPostMedia[]
  owner             User               @relation(fields: [ownerUserId], references: [id])

  @@index([ownerUserId, createdAt])
}

model BodyCheckinPhoto {
  id            String      @id @default(uuid())
  bodyCheckinId String
  mediaAssetId  String
  position      Int
  bodyCheckin   BodyCheckin @relation(fields: [bodyCheckinId], references: [id])
  media         MediaAsset  @relation(fields: [mediaAssetId], references: [id])

  @@unique([bodyCheckinId, position])
  @@index([bodyCheckinId])
}

model Group {
  id          String        @id @default(uuid())
  ownerUserId String
  name        String
  description String?
  visibility  Visibility    @default(PRIVATE)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  owner       User          @relation("GroupOwner", fields: [ownerUserId], references: [id])
  members     GroupMember[]
  posts       GroupPost[]

  @@index([ownerUserId])
}

model GroupMember {
  groupId  String
  userId   String
  role     String
  joinedAt DateTime @default(now())
  group    Group    @relation(fields: [groupId], references: [id])
  user     User     @relation(fields: [userId], references: [id])

  @@id([groupId, userId])
  @@index([userId])
}

model GroupPost {
  id           String              @id @default(uuid())
  groupId      String
  authorUserId String
  postType     GroupPostType
  content      String?
  postDate     DateTime?           @db.Date
  createdAt    DateTime            @default(now())
  author       User                @relation("GroupPostAuthor", fields: [authorUserId], references: [id])
  group        Group               @relation(fields: [groupId], references: [id])
  comments     GroupPostComment[]
  media        GroupPostMedia[]
  reactions    GroupPostReaction[]

  @@index([groupId, postDate])
  @@index([groupId, createdAt])
  @@index([authorUserId, createdAt])
}

model GroupPostMedia {
  id           String     @id @default(uuid())
  groupPostId  String
  mediaAssetId String
  position     Int
  post         GroupPost  @relation(fields: [groupPostId], references: [id])
  media        MediaAsset @relation(fields: [mediaAssetId], references: [id])

  @@unique([groupPostId, position])
  @@index([groupPostId])
}

model GroupPostReaction {
  groupPostId String
  userId      String
  reaction    ReactionType
  createdAt   DateTime     @default(now())
  post        GroupPost    @relation(fields: [groupPostId], references: [id])
  user        User         @relation(fields: [userId], references: [id])

  @@id([groupPostId, userId, reaction])
  @@index([groupPostId, createdAt])
}

model GroupPostComment {
  id           String    @id @default(uuid())
  groupPostId  String
  authorUserId String
  content      String
  createdAt    DateTime  @default(now())
  author       User      @relation(fields: [authorUserId], references: [id])
  post         GroupPost @relation(fields: [groupPostId], references: [id])

  @@index([groupPostId, createdAt])
}

enum Role {
  USER
  ADMIN
}

enum HabitType {
  ADDICTION
  CUSTOM
}

enum HabitCheckinStatus {
  SUCCESS
  FAIL
  SKIPPED
}

enum Visibility {
  PRIVATE
  INVITE_ONLY
}

enum GroupPostType {
  DAILY_CHECKIN
  MOTIVATION
  WORKOUT_CHECKIN
  BODY_CHECKIN
}

enum ReactionType {
  LIKE
  FIRE
  CLAP
}
